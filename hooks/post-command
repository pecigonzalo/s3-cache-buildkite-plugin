#!/bin/bash
set -euo pipefail

if [[ "${BUILDKITE_PLUGIN_S3_CACHE_DEBUG:-false}" =~ (true|on|1) ]]; then
  echo "--- :hammer: Enabling debug mode"
  set -x
fi

paths=()

if [[ -n "${BUILDKITE_PLUGIN_S3_CACHE_DIRECTORIES:-}" ]]; then
  paths+=("$BUILDKITE_PLUGIN_S3_CACHE_DIRECTORIES")
fi

while IFS='=' read -r path _; do
  if [[ $path =~ ^(BUILDKITE_PLUGIN_S3_CACHE_DIRECTORIES_[0-9]+) ]]; then
    paths+=("${!path}")
  fi
done < <(env | sort)

if [ "${#paths[@]}" -gt 0 ]; then
  echo "--- Compressing cache with tar"
  # Filter existing paths
  for path in "${paths[@]}"; do
    if [[ -e "$path" ]]; then
      tarlist+=("$path")
    fi
  done

  if [[ "${#tarlist[@]}" -gt 0 ]]; then
    tar vzcf "./cache.tar.gz" $present_paths

    if [[ -e "./cache.tar.gz" ]]; then
      echo "--- Uploading cache to ${BUILDKITE_PLUGIN_S3_CACHE_BUCKET}"
      aws s3 cp \
        "./cache.tar.gz" \
        "s3://${BUILDKITE_PLUGIN_S3_CACHE_BUCKET}/${BUILDKITE_PIPELINE_SLUG}/${BUILDKITE_BRANCH}.tar.gz"
    else
      echo "File cache.tar.gz missing, nothing to upload"
    fi

  else
    echo "No paths found for: "
    echo "${paths[*]}"
  fi
fi
